<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд - Игра престолов</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-primary: #1a8c8f;
            --color-secondary: #d4af37;
            --color-bg: #1a1a2e;
            --color-surface: #16213e;
            --color-text: #eaeaea;
            --color-text-secondary: #b0b0b0;
            --color-border: #303050;
            --color-kpi-1: #ff6b6b;
            --color-kpi-2: #4ecdc4;
            --color-kpi-3: #ffe66d;
            --color-kpi-4: #a29bfe;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 15px;
        }

        h1 {
            font-size: 32px;
            color: var(--color-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        /* Фильтры */
        .filters {
            background-color: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid var(--color-border);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            color: var(--color-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* Season Filter Buttons */
        .season-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .season-btn {
            padding: 8px 12px;
            background-color: var(--color-bg);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 35px;
        }

        .season-btn:hover {
            border-color: var(--color-primary);
            background-color: rgba(26, 140, 143, 0.2);
        }

        .season-btn.active {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-text);
            box-shadow: 0 0 12px rgba(26, 140, 143, 0.4);
        }

        /* Multiselect */
        .multiselect-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .multiselect-header {
            padding: 10px 12px;
            background-color: var(--color-bg);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .multiselect-header:hover {
            border-color: var(--color-primary);
            background-color: rgba(26, 140, 143, 0.1);
        }

        .multiselect-header::after {
            content: '▼';
            font-size: 10px;
            margin-left: 8px;
        }

        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-top: none;
            border-radius: 0 0 5px 5px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .multiselect-dropdown label {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--color-border);
            margin: 0;
            font-size: 14px;
            text-transform: none;
            color: var(--color-text);
            font-weight: normal;
        }

        .multiselect-dropdown label:last-child {
            border-bottom: none;
        }

        .multiselect-dropdown label:hover {
            background-color: rgba(26, 140, 143, 0.2);
        }

        .multiselect-dropdown input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        /* Filter Button */
        .btn-filter {
            padding: 10px 16px;
            background-color: var(--color-primary);
            color: var(--color-text);
            border: 1px solid var(--color-primary);
            border-radius: 5px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
        }

        .btn-filter:hover {
            background-color: var(--color-secondary);
            border-color: var(--color-secondary);
            color: var(--color-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-filter:active {
            transform: translateY(0);
        }

        /* KPI Cards */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(26, 140, 143, 0.1) 100%);
            border-left: 4px solid var(--color-primary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--color-secondary);
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }

        .kpi-card.kpi-1 { border-left-color: var(--color-kpi-1); }
        .kpi-card.kpi-2 { border-left-color: var(--color-kpi-2); }
        .kpi-card.kpi-3 { border-left-color: var(--color-kpi-3); }
        .kpi-card.kpi-4 { border-left-color: var(--color-kpi-4); }

        .kpi-label {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .kpi-1 .kpi-value { color: var(--color-kpi-1); }
        .kpi-2 .kpi-value { color: var(--color-kpi-2); }
        .kpi-3 .kpi-value { color: var(--color-kpi-3); }
        .kpi-4 .kpi-value { color: var(--color-kpi-4); }

        .kpi-change {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        /* Чарты */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background-color: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            position: relative;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        canvas {
            max-height: 350px;
        }

        /* Heatmap Container */
        .heatmap-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .heatmap-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .heatmap-label {
            min-width: 120px;
            font-size: 12px;
            color: var(--color-text-secondary);
            text-align: right;
            font-weight: 600;
        }

        .heatmap-cells {
            display: flex;
            gap: 4px;
        }

        .heatmap-cell {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        .heatmap-legend {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(26, 140, 143, 0.1);
            border-radius: 5px;
            font-size: 12px;
        }

        .heatmap-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .heatmap-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        /* Таблица */
        .table-container {
            background-color: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            overflow-x: auto;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: rgba(26, 140, 143, 0.2);
        }

        th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--color-secondary);
            border-bottom: 2px solid var(--color-border);
            font-weight: 600;
            letter-spacing: 1px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
            font-size: 14px;
        }

        tbody tr:hover {
            background-color: rgba(26, 140, 143, 0.1);
        }

        .rank {
            font-weight: 700;
            color: var(--color-secondary);
        }

        .death-count {
            color: var(--color-kpi-1);
            font-weight: 600;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            h1 {
                font-size: 24px;
            }

            .filters {
                grid-template-columns: 1fr;
            }

            .season-filter {
                gap: 4px;
            }

            .season-btn {
                flex: none;
                min-width: 40px;
                padding: 6px 8px;
            }

            .kpi-section {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            canvas {
                max-height: 300px;
            }

            .heatmap-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .heatmap-label {
                min-width: auto;
                text-align: left;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .kpi-section {
                grid-template-columns: 1fr;
            }

            .kpi-value {
                font-size: 24px;
            }

            th, td {
                padding: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>⚔️ Дашборд анализа</h1>
            <p class="subtitle">Игра престолов - статистика смертей персонажей</p>
        </header>

        <!-- Фильтры -->
        <div class="filters">
            <div class="filter-group">
                <label>Выбор сезона</label>
                <div class="season-filter">
                    <button class="season-btn active" data-season="">Все</button>
                    <button class="season-btn" data-season="1">1</button>
                    <button class="season-btn" data-season="2">2</button>
                    <button class="season-btn" data-season="3">3</button>
                    <button class="season-btn" data-season="4">4</button>
                    <button class="season-btn" data-season="5">5</button>
                    <button class="season-btn" data-season="6">6</button>
                    <button class="season-btn" data-season="7">7</button>
                    <button class="season-btn" data-season="8">8</button>
                </div>
            </div>

            <div class="filter-group">
                <label for="house">Выбор домов (множественный выбор)</label>
                <div class="multiselect-container">
                    <div class="multiselect-header" id="houseHeader">Выберите дома...</div>
                    <div class="multiselect-dropdown" id="houseDropdown" style="display: none;">
                        <label><input type="checkbox" value="stark"> Дом Старк</label>
                        <label><input type="checkbox" value="lannister"> Дом Ланнистер</label>
                        <label><input type="checkbox" value="targaryen"> Дом Таргариен</label>
                        <label><input type="checkbox" value="baratheon"> Дом Баратеон</label>
                        <label><input type="checkbox" value="tyrell"> Дом Тирелл</label>
                        <label><input type="checkbox" value="martell"> Дом Мартелл</label>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label for="deathType">Типы смертей (множественный выбор)</label>
                <div class="multiselect-container">
                    <div class="multiselect-header" id="deathTypeHeader">Выберите типы...</div>
                    <div class="multiselect-dropdown" id="deathTypeDropdown" style="display: none;">
                        <label><input type="checkbox" value="battle"> Битва</label>
                        <label><input type="checkbox" value="execution"> Казнь</label>
                        <label><input type="checkbox" value="poison"> Отравление</label>
                        <label><input type="checkbox" value="murder"> Убийство</label>
                        <label><input type="checkbox" value="other"> Прочее</label>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn-filter" id="resetBtn">Сброс фильтров</button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-section">
            <div class="kpi-card kpi-1">
                <div class="kpi-label">Всего персонажей</div>
                <div class="kpi-value" id="kpiTotal">412</div>
                <div class="kpi-change" id="kpiTotalChange">Основных персонажей в сериале</div>
            </div>

            <div class="kpi-card kpi-2">
                <div class="kpi-label">Всего смертей</div>
                <div class="kpi-value" id="kpiDeaths">230</div>
                <div class="kpi-change" id="kpiDeathsChange">55.8% от всех персонажей</div>
            </div>

            <div class="kpi-card kpi-3">
                <div class="kpi-label">Средний год смерти</div>
                <div class="kpi-value" id="kpiAverage">6.5</div>
                <div class="kpi-change" id="kpiAverageChange">В среднем сезон 6.5</div>
            </div>

            <div class="kpi-card kpi-4">
                <div class="kpi-label">Смертоносный сезон</div>
                <div class="kpi-value" id="kpiHouse">6</div>
                <div class="kpi-change" id="kpiHouseChange">Сезон 6: 42 смертей</div>
            </div>
        </div>

        <!-- Чарты -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">Смерти по сезонам</div>
                <canvas id="deathsChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Распределение по домам</div>
                <canvas id="housesChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Тренд смертей (накопительно)</div>
                <canvas id="trendChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Матрица сезон-дом</div>
                <div class="heatmap-container" id="heatmapContainer"></div>
            </div>
        </div>

        <!-- Таблица -->
        <div class="table-container">
            <div class="table-title">Топ-10 домов по количеству смертей</div>
            <table>
                <thead>
                    <tr>
                        <th>Ранг</th>
                        <th>Название дома</th>
                        <th>Смертей</th>
                        <th>Процент</th>
                        <th>Главный персонаж</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td class="rank">1</td>
                        <td>Дом Старк</td>
                        <td class="death-count">37</td>
                        <td>16.1%</td>
                        <td>Кейтилин Старк</td>
                    </tr>
                    <tr>
                        <td class="rank">2</td>
                        <td>Дом Ланнистер</td>
                        <td class="death-count">32</td>
                        <td>13.9%</td>
                        <td>Джейми Ланнистер</td>
                    </tr>
                    <tr>
                        <td class="rank">3</td>
                        <td>Дом Баратеон</td>
                        <td class="death-count">28</td>
                        <td>12.2%</td>
                        <td>Робер Баратеон</td>
                    </tr>
                    <tr>
                        <td class="rank">4</td>
                        <td>Дом Таргариен</td>
                        <td class="death-count">24</td>
                        <td>10.4%</td>
                        <td>Дейнерис Таргариен</td>
                    </tr>
                    <tr>
                        <td class="rank">5</td>
                        <td>Дом Тирелл</td>
                        <td class="death-count">19</td>
                        <td>8.3%</td>
                        <td>Маргери Тирелл</td>
                    </tr>
                    <tr>
                        <td class="rank">6</td>
                        <td>Дом Мартелл</td>
                        <td class="death-count">15</td>
                        <td>6.5%</td>
                        <td>Доран Мартелл</td>
                    </tr>
                    <tr>
                        <td class="rank">7</td>
                        <td>Дом Гарри</td>
                        <td class="death-count">14</td>
                        <td>6.1%</td>
                        <td>Станис Баратеон</td>
                    </tr>
                    <tr>
                        <td class="rank">8</td>
                        <td>Дом Сьюзерланд</td>
                        <td class="death-count">13</td>
                        <td>5.7%</td>
                        <td>Эддард Старк</td>
                    </tr>
                    <tr>
                        <td class="rank">9</td>
                        <td>Дом Ройс</td>
                        <td class="death-count">11</td>
                        <td>4.8%</td>
                        <td>Росс Хорнвуд</td>
                    </tr>
                    <tr>
                        <td class="rank">10</td>
                        <td>Дом Фрей</td>
                        <td class="death-count">10</td>
                        <td>4.3%</td>
                        <td>Уолдер Фрей</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Основные данные
        const fullData = {
            seasons: [12, 18, 25, 32, 38, 42, 28, 35],
            seasonLabels: ['Сезон 1', 'Сезон 2', 'Сезон 3', 'Сезон 4', 'Сезон 5', 'Сезон 6', 'Сезон 7', 'Сезон 8'],
            houses: { 'Старк': 37, 'Ланнистер': 32, 'Баратеон': 28, 'Таргариен': 24, 'Тирелл': 19, 'Мартелл': 15, 'Гарри': 14, 'Другие': 46 },
            deathTypes: { 'Битва': 45, 'Казнь': 38, 'Убийство': 62, 'Отравление': 28, 'Прочее': 57 },
            // Матрица сезон-дом (сезон × дом)
            seasonHouseMatrix: {
                'Старк': [2, 4, 7, 5, 6, 4, 2, 1],
                'Ланнистер': [1, 3, 5, 6, 5, 4, 3, 2],
                'Таргариен': [1, 2, 3, 4, 5, 6, 2, 1],
                'Баратеон': [2, 3, 4, 5, 4, 3, 2, 3],
                'Тирелл': [1, 1, 2, 3, 3, 4, 2, 3],
                'Мартелл': [0, 1, 2, 2, 2, 3, 2, 2],
                'Гарри': [2, 1, 1, 2, 2, 3, 1, 2],
                'Другие': [3, 3, 1, 5, 11, 15, 14, 21]
            },
            // Доступные типы смерти по домам
            deathTypesByHouse: {
                'Старк': { 'Битва': 12, 'Казнь': 8, 'Убийство': 15, 'Отравление': 2 },
                'Ланнистер': { 'Битва': 10, 'Казнь': 6, 'Убийство': 12, 'Отравление': 4 },
                'Таргариен': { 'Битва': 8, 'Казнь': 5, 'Убийство': 10, 'Отравление': 1 },
                'Баратеон': { 'Битва': 9, 'Казнь': 7, 'Убийство': 10, 'Отравление': 2 },
                'Тирелл': { 'Битва': 3, 'Казнь': 4, 'Убийство': 8, 'Отравление': 4 },
                'Мартелл': { 'Битва': 2, 'Казнь': 3, 'Убийство': 8, 'Отравление': 2 },
                'Гарри': { 'Битва': 1, 'Казнь': 2, 'Убийство': 9, 'Отравление': 2 },
                'Другие': { 'Битва': 0, 'Казнь': 3, 'Убийство': 0, 'Отравление': 9, 'Прочее': 34 }
            }
        };

        // Текущие фильтры
        let currentFilters = {
            season: '',
            houses: [],
            deathTypes: []
        };

        // Хранилище графиков
        let charts = {};

        // Цвета (фиксированные для домов)
        const houseColors = {
            'Старк': '#ff6b6b',
            'Ланнистер': '#ffe66d',
            'Таргариен': '#a29bfe',
            'Баратеон': '#4ecdc4',
            'Тирелл': '#fd79a8',
            'Мартелл': '#fdcb6e',
            'Гарри': '#6c5ce7',
            'Другие': '#95a5a6'
        };

        const colors = Object.values(houseColors);

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#eaeaea', font: { size: 12 } }
                }
            },
            scales: {
                x: { ticks: { color: '#b0b0b0' }, grid: { color: 'rgba(48, 48, 80, 0.3)' } },
                y: { ticks: { color: '#b0b0b0' }, grid: { color: 'rgba(48, 48, 80, 0.3)' } }
            }
        };

        // Инициализация графиков
        function initializeCharts() {
            // Чарт 1: Смерти по сезонам (стеккированная столбчатая диаграмма)
            const deathsBySeasonData = prepareDeathsBySeasonData();
            charts.deathsChart = new Chart(document.getElementById('deathsChart'), {
                type: 'bar',
                data: deathsBySeasonData,
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: { ...chartOptions.scales.x, stacked: true },
                        y: { ...chartOptions.scales.y, stacked: true }
                    }
                }
            });

            // Чарт 2: Распределение по домам (круговая)
            charts.housesChart = new Chart(document.getElementById('housesChart'), {
                type: 'doughnut',
                data: prepareHousesData(),
                options: chartOptions
            });

            // Чарт 3: Тренд смертей (накопительный)
            charts.trendChart = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: prepareTrendData(),
                options: chartOptions
            });

            // Хеатмап (матрица сезон-дом)
            renderHeatmap();
        }

        // Подготовка данных для столбчатой диаграммы
        function prepareDeathsBySeasonData() {
            const datasets = [];
            const selectedHouses = currentFilters.houses.length > 0 ? currentFilters.houses : Object.keys(houseColors);

            selectedHouses.forEach(house => {
                datasets.push({
                    label: house,
                    data: fullData.seasonHouseMatrix[house] || [],
                    backgroundColor: houseColors[house],
                    borderColor: houseColors[house],
                    borderWidth: 0,
                    borderRadius: 5
                });
            });

            return {
                labels: fullData.seasonLabels,
                datasets: datasets
            };
        }

        // Подготовка данных для круговой диаграммы
        function prepareHousesData() {
            const labels = Object.keys(fullData.houses);
            const data = Object.values(fullData.houses);
            const backgroundColors = labels.map(h => houseColors[h]);

            return {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors
                }]
            };
        }

        // Подготовка данных для линейного графика (тренда)
        function prepareTrendData() {
            const selectedHouses = currentFilters.houses.length > 0 ? currentFilters.houses : Object.keys(houseColors);
            const datasets = [];

            selectedHouses.forEach(house => {
                const cumulativeData = [];
                let sum = 0;
                fullData.seasonHouseMatrix[house].forEach(val => {
                    sum += val;
                    cumulativeData.push(sum);
                });

                datasets.push({
                    label: `${house} (накопл.)`,
                    data: cumulativeData,
                    borderColor: houseColors[house],
                    backgroundColor: `${houseColors[house]}20`,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: houseColors[house],
                    pointRadius: 4
                });
            });

            return {
                labels: fullData.seasonLabels,
                datasets: datasets
            };
        }

        // Рендер хеатмапа
        function renderHeatmap() {
            const container = document.getElementById('heatmapContainer');
            container.innerHTML = '';

            const houseNames = Object.keys(fullData.seasonHouseMatrix);
            let maxValue = 0;
            houseNames.forEach(house => {
                fullData.seasonHouseMatrix[house].forEach(val => {
                    if (val > maxValue) maxValue = val;
                });
            });

            houseNames.forEach(house => {
                const row = document.createElement('div');
                row.className = 'heatmap-row';

                const label = document.createElement('div');
                label.className = 'heatmap-label';
                label.textContent = house;
                row.appendChild(label);

                const cellsDiv = document.createElement('div');
                cellsDiv.className = 'heatmap-cells';

                fullData.seasonHouseMatrix[house].forEach((value, seasonIdx) => {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.textContent = value;
                    cell.title = `${house}, ${fullData.seasonLabels[seasonIdx]}: ${value} смертей`;

                    const intensity = value / maxValue;
                    const hue = 0;
                    const saturation = 70;
                    const lightness = 50 - (intensity * 40);
                    cell.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;

                    cellsDiv.appendChild(cell);
                });

                row.appendChild(cellsDiv);
                container.appendChild(row);
            });

            // Легенда
            const legend = document.createElement('div');
            legend.className = 'heatmap-legend';
            legend.innerHTML = `
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-color" style="background-color: hsl(0, 70%, 90%);"></div>
                    <span>Низко (0-${Math.ceil(maxValue/3)})</span>
                </div>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-color" style="background-color: hsl(0, 70%, 50%);"></div>
                    <span>Средне (${Math.ceil(maxValue/3)}-${Math.ceil(maxValue*2/3)})</span>
                </div>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-color" style="background-color: hsl(0, 70%, 20%);"></div>
                    <span>Высоко (${Math.ceil(maxValue*2/3)}-${maxValue})</span>
                </div>
            `;
            container.appendChild(legend);
        }

        // Обновление KPI
        function updateKPIs() {
            const totalDeaths = fullData.seasons.reduce((a, b) => a + b, 0);
            const avgSeason = (fullData.seasons.reduce((a, b) => a + b, 0) / fullData.seasons.length).toFixed(1);
            const maxSeasonIdx = fullData.seasons.indexOf(Math.max(...fullData.seasons));
            const maxSeasonDeaths = Math.max(...fullData.seasons);

            document.getElementById('kpiTotal').textContent = '412';
            document.getElementById('kpiTotalChange').textContent = '100% основных персонажей';

            document.getElementById('kpiDeaths').textContent = totalDeaths;
            const deathPercent = ((totalDeaths / 412) * 100).toFixed(1);
            document.getElementById('kpiDeathsChange').textContent = `${deathPercent}% от всех персонажей`;

            document.getElementById('kpiAverage').textContent = avgSeason;
            document.getElementById('kpiAverageChange').textContent = `${avgSeason} смертей в среднем`;

            document.getElementById('kpiHouse').textContent = (maxSeasonIdx + 1);
            document.getElementById('kpiHouseChange').textContent = `Сезон ${maxSeasonIdx + 1}: ${maxSeasonDeaths} смертей`;
        }

        // Обработчики событий фильтров
        document.querySelectorAll('.season-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.season-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilters.season = this.dataset.season;
                updateDashboard();
            });
        });

        // Обработчик мультиселекта для домов
        document.getElementById('houseHeader').addEventListener('click', function() {
            const dropdown = document.getElementById('houseDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        });

        document.querySelectorAll('#houseDropdown input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                currentFilters.houses = Array.from(
                    document.querySelectorAll('#houseDropdown input[type="checkbox"]:checked')
                ).map(cb => {
                    const label = cb.parentElement.textContent.trim();
                    return label.replace('Дом ', '');
                });

                const selected = currentFilters.houses.length;
                const header = document.getElementById('houseHeader');
                header.textContent = selected > 0 ? `Выбрано: ${selected}` : 'Выберите дома...';
                updateDashboard();
            });
        });

        // Обработчик мультиселекта для типов смерти
        document.getElementById('deathTypeHeader').addEventListener('click', function() {
            const dropdown = document.getElementById('deathTypeDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        });

        document.querySelectorAll('#deathTypeDropdown input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                currentFilters.deathTypes = Array.from(
                    document.querySelectorAll('#deathTypeDropdown input[type="checkbox"]:checked')
                ).map(cb => cb.parentElement.textContent.trim());

                const selected = currentFilters.deathTypes.length;
                const header = document.getElementById('deathTypeHeader');
                header.textContent = selected > 0 ? `Выбрано: ${selected}` : 'Выберите типы...';
                updateDashboard();
            });
        });

        // Сброс фильтров
        document.getElementById('resetBtn').addEventListener('click', function() {
            currentFilters = { season: '', houses: [], deathTypes: [] };
            document.querySelectorAll('.season-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.season-btn[data-season=""]').classList.add('active');
            document.querySelectorAll('#houseDropdown input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#deathTypeDropdown input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('houseHeader').textContent = 'Выберите дома...';
            document.getElementById('deathTypeHeader').textContent = 'Выберите типы...';
            updateDashboard();
        });

        // Обновление дашборда
        function updateDashboard() {
            if (charts.deathsChart) charts.deathsChart.destroy();
            if (charts.housesChart) charts.housesChart.destroy();
            if (charts.trendChart) charts.trendChart.destroy();

            initializeCharts();
            updateKPIs();
        }

        // Закрытие dropdown'ов при клике снаружи
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multiselect-container')) {
                document.getElementById('houseDropdown').style.display = 'none';
                document.getElementById('deathTypeDropdown').style.display = 'none';
            }
        });

        // Инициализация
        initializeCharts();
        updateKPIs();
    </script>
</body>
</html>
